(()=>{"use strict";function e(e,a){(null==a||a>e.length)&&(a=e.length);for(var t=0,n=new Array(a);t<a;t++)n[t]=e[t];return n}var a=function(e){return alert("Error!\n"+e.message),!1},t=function(e,a,t){if(null==e||isNaN(parseFloat(e)))return a*t;var n=parseFloat(e),r=e.replace(/[0-9]*/,"").match(/pt|cm|mm|Q|H|px|%/);if(null!=r)switch(r[0]){case"pt":return n;case"cm":return 28.346*n;case"mm":return 2.8346*n;case"Q":case"H":return 2.8346*n*.25;case"px":return.75*n;case"%":return n/100*a}return 0},n=[{before:unescape("%u3041"),after:unescape("%u3042")},{before:unescape("%u3043"),after:unescape("%u3044")},{before:unescape("%u3045"),after:unescape("%u3046")},{before:unescape("%u3047"),after:unescape("%u3048")},{before:unescape("%u3049"),after:unescape("%u304A")},{before:unescape("%u3063"),after:unescape("%u3064")},{before:unescape("%u3083"),after:unescape("%u3084")},{before:unescape("%u3085"),after:unescape("%u3086")},{before:unescape("%u3087"),after:unescape("%u3088")},{before:unescape("%u308E"),after:unescape("%u308F")},{before:unescape("%u30A1"),after:unescape("%u30A2")},{before:unescape("%u30A3"),after:unescape("%u30A4")},{before:unescape("%u30A5"),after:unescape("%u30A6")},{before:unescape("%u30A7"),after:unescape("%u30A8")},{before:unescape("%u30A9"),after:unescape("%u30AA")},{before:unescape("%u30F5"),after:unescape("%u30AB")},{before:unescape("%u31F0"),after:unescape("%u30AF")},{before:unescape("%u30F6"),after:unescape("%u30B1")},{before:unescape("%u31F1"),after:unescape("%u30B7")},{before:unescape("%u31F2"),after:unescape("%u30B9")},{before:unescape("%u30C3"),after:unescape("%u30C4")},{before:unescape("%u31F3"),after:unescape("%u30C8")},{before:unescape("%u31F4"),after:unescape("%u30CC")},{before:unescape("%u31F5"),after:unescape("%u30CF")},{before:unescape("%u31F6"),after:unescape("%u30D2")},{before:unescape("%u31F7"),after:unescape("%u30D5")},{before:unescape("%u31F8"),after:unescape("%u30D8")},{before:unescape("%u31F9"),after:unescape("%u30DB")},{before:unescape("%u31FA"),after:unescape("%u30DE")},{before:unescape("%u30E3"),after:unescape("%u30E4")},{before:unescape("%u30E5"),after:unescape("%u30E6")},{before:unescape("%u30E7"),after:unescape("%u30E8")},{before:unescape("%u31FB"),after:unescape("%u30E9")},{before:unescape("%u31FC"),after:unescape("%u30EA")},{before:unescape("%u31FD"),after:unescape("%u30EB")},{before:unescape("%u31FE"),after:unescape("%u30EC")},{before:unescape("%u31FF"),after:unescape("%u30ED")},{before:unescape("%u30EE"),after:unescape("%u30EF")},{before:unescape("%u31F7%u309A"),after:unescape("%u30D7")}];function r(e){for(var a in n)e=e.replace(n[a].before,n[a].after);return e}var u=String.fromCharCode(13),s=String.fromCharCode(10),c={space:unescape("%u0020"),zenkakuSpace:unescape("%u3000"),emSpace:unescape("%u2003"),CR:u,LF:s,tab:"\t"};!function(){var n,u,s,o=function(a,t){var n="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!n){if(Array.isArray(a)||(n=function(a,t){if(a){if("string"==typeof a)return e(a,t);var n=Object.prototype.toString.call(a).slice(8,-1);return"Object"===n&&a.constructor&&(n=a.constructor.name),"Map"===n||"Set"===n?Array.from(a):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(a,t):void 0}}(a))||t&&a&&"number"==typeof a.length){n&&(a=n);var r=0,u=function(){};return{s:u,n:function(){return r>=a.length?{done:!0}:{done:!1,value:a[r++]}},e:function(e){throw e},f:u}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,c=!0,o=!1;return{s:function(){n=n.call(a)},n:function(){var e=n.next();return c=e.done,e},e:function(e){o=!0,s=e},f:function(){try{c||null==n.return||n.return()}finally{if(o)throw s}}}}(activeDocument.selection);try{for(o.s();!(s=o.n()).done;){var f=s.value;"TextFrame"==f.typename&&null!=f.name.match(/finish/)&&(n=f),"TextFrame"==f.typename&&null!=f.name.match(/base/)&&(u=f)}}catch(e){o.e(e)}finally{o.f()}if(null==n||null==u)return a(new Error('Please, select the two object of textframe including "finish" and "base" in the name')),!1;for(var i=u.textRange.contents,p=activeDocument.groupItems.add(),l=n.orientation==TextOrientation.VERTICAL?"vertical":"horizontal",b=null,h=null,m=null,v="kata",g=!1,y=!0,x=[],d=0,F=0;F<i.length;F++){var A=new RegExp(Object.values(c).join("|"));try{if(null==i[F].match(A))if("["==i[F]&&"["!=i[F+1]){var k,E=i.substring(F+1,i.indexOf("]")),w={text:E,kanji:E.split("[")[0],kana:g?E.split("[")[1]:r(E.split("[")[1])};i=i.substring(0,F)+w.kanji+i.substr(i.indexOf("]")+1);var C=n.duplicate().createOutline(),j=C.compoundPathItems,z=C.compoundPathItems.length-d-1,O={kana:w.kana,alignment:v,font:null!==(k=b)&&void 0!==k?k:n.characters[F].characterAttributes.textFont,x:0,y:0,baseWidth:0,baseHeight:0,offset:0,narrow:y,size:{ruby:0,base:0}};if("vertical"===l){O.y=j[z].top;for(var S=0;S<w.kanji.length;S++){var D=j[z-S].left;O.x=null==O.x||O.x<D?D:O.x}}else{O.x=j[z].left;for(var R=0;R<w.kanji.length;R++){var T=j[z-R].top;O.y=null==O.y||O.y<T?T:O.y}}O.baseWidth=j[z-w.kanji.length+1].left+j[z-w.kanji.length+1].width-O.x,O.baseHeight=O.y-j[z-w.kanji.length+1].top+j[z-w.kanji.length+1].height,O.size.base=n.characters[F].characterAttributes.size,O.size.ruby=t(h,O.size.base,.5),O.offset=t(m,O.size.base,0),C.remove(),x.push(O)}else if("["==i[F]&&"["==i[F+1])F++;else if("("==i[F]&&"("!=i[F+1]){var I=i.substring(F+1,i.indexOf(")")),B={text:I,property:I.split("(")[0],value:I.split("(")[1]};switch(i=i.substring(0,F)+i.substring(i.indexOf(")")+1),B.property){case"align":v="naka"==B.value?"naka":"kata";break;case"size":h="base"==B.value?null:B.value;break;case"offset":m="base"==B.value?null:B.value;break;case"sutegana":g="true"==B.value;break;case"narrow":y="false"!=B.value;break;case"font":var H="base"==B.value?null:B.value;try{b=app.textFonts.getByName(H).name}catch(e){b=null}}F--,d--}else"("==i[F]&&"("==i[F+1]?F++:d--}catch(e){return a(new Error('Please check that the own two text textframe including name "finish" and "base" was pair.')),!1}d++}for(var W=function(e){var a=x[e].size.ruby,t=x[e].alignment,n=a*x[e].kana.length,r="vertical"===l,u=p.textFrames.add();u.textRange.characterAttributes.size=a,u.textRange.characterAttributes.textFont=x[e].font,u.contents=x[e].kana;var s=1,c=r?x[e].x:x[e].y;x.forEach((function(t,n){if(n!==e){var u=r?x[e].x-t.x:x[e].y-t.y;u<.5*a&&u>-.5*a&&(c+=r?t.x:t.y,s++)}})),c/=s,u.orientation=r?TextOrientation.VERTICAL:TextOrientation.HORIZONTAL,r?(x[e].baseHeight-n>-.3*a||!x[e].narrow?u.top="kata"===t?x[e].y:x[e].y-(x[e].baseHeight-n)/2:(u.top=x[e].y,u.textRange.characterAttributes.horizontalScale=x[e].baseHeight/n*100),u.left=c+x[e].size.base+x[e].offset):(x[e].baseWidth-n>-.3*a||!x[e].narrow?u.left="kata"==t?x[e].x:x[e].x+(x[e].baseWidth-n)/2:(u.left=x[e].x,u.textRange.characterAttributes.horizontalScale=x[e].baseWidth/n*100),u.top=c+a+x[e].offset)},L=0;L<x.length;L++)W(L);alert("Finished\nThe number of wrote ruby characters : "+x.length)}()})();